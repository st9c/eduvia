<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Home - Eduvia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --bg:#f7f7f8; --card:#fff; --text:#222; --muted:#666; --primary:#2563eb; --danger:#b91c1c; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:16px; background:#fff; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; }
    main { max-width:1000px; margin:20px auto; padding:0 16px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .card { background:var(--card); border:1px solid #e5e7eb; border-radius:8px; padding:16px; flex:1; min-width:300px; }
    h2 { margin:0 0 8px; font-size:18px; }
    h3 { margin:16px 0 8px; font-size:16px; }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:4px; }
    input, select, textarea { width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px; }
    button { padding:8px 12px; border:0; border-radius:6px; background:var(--primary); color:#fff; cursor:pointer; font-weight:600; }
    button.secondary { background:#e5e7eb; color:#111; }
    button.danger { background:var(--danger); }
    ul { list-style:none; padding:0; margin:0; }
    li { padding:8px 0; border-bottom:1px solid #eee; }
    .muted { color:var(--muted); font-size:12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .hidden { display:none; }
    .spacer { height:8px; }
    .inline { display:flex; gap:8px; align-items:center; }
    .right { float:right; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f0f4ff; color:#1e3a8a; font-size:12px; }
    .file-row { display:flex; align-items:center; gap:8px; }
    a.download { color:#2563eb; text-decoration:none; }
    a.download:hover { text-decoration:underline; }
    .id { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; color:#444; }
  </style>
</head>
<body>
  <header>
    <div><strong>Eduvia</strong> <span id="userRole" class="pill"></span></div>
    <div class="inline">
      <span id="userName" class="muted"></span>
      <button id="logoutBtn" class="secondary">Logout</button>
    </div>
  </header>

  <main>
    <div id="authView" class="card">
      <h2>Welcome</h2>
      <div class="grid">
        <div>
          <h3>Login</h3>
          <label>Email</label><input id="loginEmail" type="email" />
          <label>Password</label><input id="loginPassword" type="password" />
          <div class="spacer"></div>
          <button id="loginBtn">Login</button>
          <div id="loginError" class="muted"></div>
        </div>
        <div>
          <h3>Register</h3>
          <label>Name</label><input id="regName" />
          <label>Email</label><input id="regEmail" type="email" />
          <label>Password</label><input id="regPassword" type="password" />
          <label>Role</label>
          <select id="regRole">
            <option value="STUDENT">Student</option>
            <option value="PROFESSOR">Professor</option>
          </select>
          <div class="spacer"></div>
          <button id="registerBtn">Create Account</button>
          <div id="registerError" class="muted"></div>
        </div>
      </div>
    </div>

    <div id="profView" class="hidden">
      <div class="row">
        <div class="card">
          <h2>Your Courses</h2>
          <ul id="profCourses"></ul>
          <div class="spacer"></div>
          <h3>Create Course</h3>
          <label>Title</label><input id="courseTitle" />
          <label>Description</label><textarea id="courseDesc"></textarea>
          <div class="spacer"></div>
          <button id="createCourseBtn">Create</button>
          <div id="courseMsg" class="muted"></div>
        </div>

        <div class="card">
          <h2>Assignments</h2>
          <label>Course</label>
          <select id="assignCourse"></select>
          <label>Title</label><input id="assignTitle" />
          <label>Description</label><textarea id="assignDesc"></textarea>
          <label>Due Date</label><input id="assignDue" type="datetime-local" />
          <div class="spacer"></div>
          <button id="createAssignBtn">Post Assignment</button>
          <div id="assignMsg" class="muted"></div>

          <h3>View by Course</h3>
          <select id="viewAssignCourse"></select>
          <div class="spacer"></div>
          <ul id="assignList"></ul>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <h2>Submissions (by Assignment)</h2>
          <label>Assignment ID</label><input id="subAssignmentId" placeholder="Enter assignment ID" />
          <div class="spacer"></div>
          <button id="loadSubsBtn">Load Submissions</button>
          <div class="spacer"></div>
          <ul id="subsList"></ul>
        </div>

        <div class="card">
          <h2>Messages</h2>
          <label>Recipient (User ID)</label><input id="msgRecipient" />
          <label>Course (optional, Course ID)</label><input id="msgCourseOpt" />
          <label>Content</label><textarea id="msgContent"></textarea>
          <div class="spacer"></div>
          <button id="sendMsgBtn">Send</button>
          <div id="msgSendStatus" class="muted"></div>

          <h3>Inbox</h3>
          <ul id="inboxList"></ul>
          <h3>Sent</h3>
          <ul id="sentList"></ul>
        </div>
      </div>
    </div>

    <div id="studentView" class="hidden">
      <div class="row">
        <div class="card">
          <h2>Your Enrolled Courses</h2>
          <ul id="stuCourses"></ul>
          <h3>Enroll in Course</h3>
          <label>Course ID</label><input id="enrollCourseId" />
          <div class="spacer"></div>
          <button id="enrollBtn">Enroll</button>
          <div id="enrollMsg" class="muted"></div>
        </div>

        <div class="card">
          <h2>Assignments (by Course)</h2>
          <label>Course ID</label><input id="stuAssignCourseId" />
          <div class="spacer"></div>
          <button id="loadStuAssignBtn">Load</button>
          <ul id="stuAssignList"></ul>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <h2>Submit Assignment</h2>
          <label>Assignment ID</label><input id="submitAssignmentId" />
          <label>File</label>
          <div class="file-row">
            <input id="submitFile" type="file" />
          </div>
          <div class="spacer"></div>
          <button id="submitBtn">Upload</button>
          <div id="submitMsg" class="muted"></div>
        </div>

        <div class="card">
          <h2>Messages</h2>
          <label>Recipient (User ID)</label><input id="stuMsgRecipient" />
          <label>Course (optional, Course ID)</label><input id="stuMsgCourseOpt" />
          <label>Content</label><textarea id="stuMsgContent"></textarea>
          <div class="spacer"></div>
          <button id="stuSendMsgBtn">Send</button>
          <div id="stuMsgSendStatus" class="muted"></div>

          <h3>Inbox</h3>
          <ul id="stuInboxList"></ul>
          <h3>Sent</h3>
          <ul id="stuSentList"></ul>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = "https://st9c.github.io/eduvia/api";
    const state = {
      token: null,
      user: null,
      role: null,
      profCourses: []
    };

    function setAuth(token) {
      state.token = token;
      if (token) localStorage.setItem("token", token);
      else localStorage.removeItem("token");
    }

    async function api(path, opts = {}) {
      const headers = opts.headers || {};
      if (state.token) headers["Authorization"] = "Bearer " + state.token;
      if (!(opts.body instanceof FormData)) {
        headers["Content-Type"] = headers["Content-Type"] || "application/json";
      }
      const res = await fetch(API_BASE + path, { ...opts, headers });
      const text = await res.text();
      let data = {};
      try { data = text ? JSON.parse(text) : {}; } catch { data = {}; }
      if (!res.ok) throw new Error(data.error || "Request failed");
      return data;
    }

    function show(id) { document.getElementById(id).classList.remove("hidden"); }
    function hide(id) { document.getElementById(id).classList.add("hidden"); }
    function setText(id, text) { document.getElementById(id).textContent = text; }
    function setHTML(id, html) { document.getElementById(id).innerHTML = html; }

    function renderAuth() {
      hide("profView"); hide("studentView");
      show("authView");
      setText("userRole", "");
      setText("userName", "");
    }

    function renderRole() {
      hide("authView");
      setText("userRole", state.role || "");
      setText("userName", state.user ? state.user.name + " (" + state.user.email + ")" : "");
      if (state.role === "PROFESSOR") {
        show("profView");
        hide("studentView");
        loadProfessorData();
      } else if (state.role === "STUDENT") {
        show("studentView");
        hide("profView");
        loadStudentData();
      }
    }

    async function loadProfessorData() {
      try {
        const courses = await api("/courses", { method: "GET" });
        state.profCourses = courses;
        setHTML("profCourses", courses.map(c => `
          <li>
            <strong>${escapeHtml(c.title)}</strong> — ${escapeHtml(c.description)}
            <span class="id">id: ${c.id}</span>
          </li>
        `).join("") || "<li class='muted'>No courses yet.</li>");

        const options = courses.map(c => `<option value="${c.id}">${escapeHtml(c.title)}</option>`).join("");
        setHTML("assignCourse", `<option value="">Select course</option>${options}`);
        setHTML("viewAssignCourse", `<option value="">Select course</option>${options}`);
        setHTML("assignList", "");
        await loadInboxSent("inboxList", "sentList");
      } catch (e) {
        setText("courseMsg", e.message);
      }
    }

    async function loadStudentData() {
      try {
        const courses = await api("/courses", { method: "GET" });
        setHTML("stuCourses", courses.map(c => `
          <li>
            <strong>${escapeHtml(c.title)}</strong> — ${escapeHtml(c.description)}
            <span class="id">id: ${c.id}</span>
          </li>
        `).join("") || "<li class='muted'>Not enrolled in any courses.</li>");
        await loadInboxSent("stuInboxList", "stuSentList");
      } catch (e) {
        setText("enrollMsg", e.message);
      }
    }

    async function loadInboxSent(inboxElId, sentElId) {
      try {
        const inbox = await api("/messages/inbox", { method: "GET" });
        const sent = await api("/messages/sent", { method: "GET" });
        setHTML(inboxElId, inbox.map(m => `
          <li>
            <div><strong>From:</strong> ${m.sender ? escapeHtml(m.sender.name) : "Unknown"} <span class="id">${m.sender ? m.sender.id : ""}</span></div>
            <div>${escapeHtml(m.content)}</div>
            <div class="muted">${new Date(m.createdAtISO).toLocaleString()} ${m.courseId ? " • Course " + m.courseId : ""}</div>
          </li>
        `).join("") || "<li class='muted'>No messages.</li>");

        setHTML(sentElId, sent.map(m => `
          <li>
            <div><strong>To:</strong> ${m.recipient ? escapeHtml(m.recipient.name) : "Unknown"} <span class="id">${m.recipient ? m.recipient.id : ""}</span></div>
            <div>${escapeHtml(m.content)}</div>
            <div class="muted">${new Date(m.createdAtISO).toLocaleString()} ${m.courseId ? " • Course " + m.courseId : ""}</div>
          </li>
        `).join("") || "<li class='muted'>No sent messages.</li>");
      } catch (e) {
        // Show minimal error in both
        setHTML(inboxElId, `<li class='muted'>Failed to load inbox: ${escapeHtml(e.message)}</li>`);
        setHTML(sentElId, `<li class='muted'>Failed to load sent: ${escapeHtml(e.message)}</li>`);
      }
    }

    // Event handlers
    document.getElementById("logoutBtn").addEventListener("click", () => {
      setAuth(null);
      state.user = null;
      state.role = null;
      renderAuth();
    });

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value.trim();
      setText("loginError", "");
      try {
        const res = await api("/auth/login", { method: "POST", body: JSON.stringify({ email, password }) });
        setAuth(res.token);
        state.user = res.user;
        state.role = res.user.role;
        renderRole();
      } catch (e) {
        setText("loginError", e.message);
      }
    });

    document.getElementById("registerBtn").addEventListener("click", async () => {
      const name = document.getElementById("regName").value.trim();
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value.trim();
      const role = document.getElementById("regRole").value;
      setText("registerError", "");
      try {
        const res = await api("/auth/register", { method: "POST", body: JSON.stringify({ name, email, password, role }) });
        setAuth(res.token);
        state.user = res.user;
        state.role = res.user.role;
        renderRole();
      } catch (e) {
        setText("registerError", e.message);
      }
    });

    // Professor: Create course
    document.getElementById("createCourseBtn").addEventListener("click", async () => {
      const title = document.getElementById("courseTitle").value.trim();
      const description = document.getElementById("courseDesc").value.trim();
      setText("courseMsg", "");
      try {
        const course = await api("/courses", { method: "POST", body: JSON.stringify({ title, description }) });
        setText("courseMsg", "Created course: " + course.id);
        document.getElementById("courseTitle").value = "";
        document.getElementById("courseDesc").value = "";
        await loadProfessorData();
      } catch (e) {
        setText("courseMsg", e.message);
      }
    });

    // Professor: Create assignment
    document.getElementById("createAssignBtn").addEventListener("click", async () => {
      const courseId = document.getElementById("assignCourse").value;
      const title = document.getElementById("assignTitle").value.trim();
      const description = document.getElementById("assignDesc").value.trim();
      const dueDate = document.getElementById("assignDue").value;
      setText("assignMsg", "");
      if (!courseId) { setText("assignMsg", "Select a course"); return; }
      try {
        const a = await api("/assignments", { method: "POST", body: JSON.stringify({ courseId, title, description, dueDate }) });
        setText("assignMsg", "Posted assignment: " + a.id);
        document.getElementById("assignTitle").value = "";
        document.getElementById("assignDesc").value = "";
        document.getElementById("assignDue").value = "";
        // refresh assignment list for selected "view" course if same
        if (document.getElementById("viewAssignCourse").value === courseId) {
          await loadAssignmentsForCourse(courseId);
        }
      } catch (e) {
        setText("assignMsg", e.message);
      }
    });

    // Professor: View assignments by course
    document.getElementById("viewAssignCourse").addEventListener("change", async (e) => {
      const courseId = e.target.value;
      if (!courseId) { setHTML("assignList", ""); return; }
      await loadAssignmentsForCourse(courseId);
    });

    async function loadAssignmentsForCourse(courseId) {
      try {
        const items = await api(`/assignments/by-course/${courseId}`, { method: "GET" });
        setHTML("assignList", items.map(a => `
          <li>
            <div><strong>${escapeHtml(a.title)}</strong> <span class="id">id: ${a.id}</span></div>
            <div>${escapeHtml(a.description)}</div>
            <div class="muted">Due: ${new Date(a.dueDateISO).toLocaleString()}</div>
          </li>
        `).join("") || "<li class='muted'>No assignments.</li>");
      } catch (e) {
        setHTML("assignList", `<li class='muted'>${escapeHtml(e.message)}</li>`);
      }
    }

    // Professor: Load submissions for assignment
    document.getElementById("loadSubsBtn").addEventListener("click", async () => {
      const assignmentId = document.getElementById("subAssignmentId").value.trim();
      setHTML("subsList", "");
      if (!assignmentId) { setHTML("subsList", "<li class='muted'>Enter assignment ID.</li>"); return; }
      try {
        const subs = await api(`/submissions/by-assignment/${assignmentId}`, { method: "GET" });
        setHTML("subsList", subs.map(s => `
          <li>
            <div><strong>${s.student ? escapeHtml(s.student.name) : "Unknown"}</strong> <span class="id">${s.student ? s.student.id : ""}</span></div>
            <div class="muted">${new Date(s.createdAtISO).toLocaleString()}</div>
            <div class="inline">
              <span>${escapeHtml(s.originalName)} (${Math.round(s.sizeBytes/1024)} KB)</span>
              <a class="download" href="${s.downloadUrl}" target="_blank" rel="noopener">Download</a>
            </div>
          </li>
        `).join("") || "<li class='muted'>No submissions yet.</li>");
      } catch (e) {
        setHTML("subsList", `<li class='muted'>${escapeHtml(e.message)}</li>`);
      }
    });

    // Professor: Send message
    document.getElementById("sendMsgBtn").addEventListener("click", async () => {
      const recipientId = document.getElementById("msgRecipient").value.trim();
      const courseId = document.getElementById("msgCourseOpt").value.trim();
      const content = document.getElementById("msgContent").value.trim();
      setText("msgSendStatus", "");
      try {
        await api("/messages", { method: "POST", body: JSON.stringify({ recipientId, content, courseId: courseId || undefined }) });
        setText("msgSendStatus", "Message sent.");
        document.getElementById("msgRecipient").value = "";
        document.getElementById("msgCourseOpt").value = "";
        document.getElementById("msgContent").value = "";
        await loadInboxSent("inboxList", "sentList");
      } catch (e) {
        setText("msgSendStatus", e.message);
      }
    });

    // Student: Enroll
    document.getElementById("enrollBtn").addEventListener("click", async () => {
      const courseId = document.getElementById("enrollCourseId").value.trim();
      setText("enrollMsg", "");
      try {
        const r = await api("/courses/enroll", { method: "POST", body: JSON.stringify({ courseId }) });
        setText("enrollMsg", "Enrolled in course: " + r.courseId);
        document.getElementById("enrollCourseId").value = "";
        await loadStudentData();
      } catch (e) {
        setText("enrollMsg", e.message);
      }
    });

    // Student: Load assignments
    document.getElementById("loadStuAssignBtn").addEventListener("click", async () => {
      const courseId = document.getElementById("stuAssignCourseId").value.trim();
      setHTML("stuAssignList", "");
      if (!courseId) { setHTML("stuAssignList", "<li class='muted'>Enter course ID.</li>"); return; }
      try {
        const items = await api(`/assignments/by-course/${courseId}`, { method: "GET" });
        setHTML("stuAssignList", items.map(a => `
          <li>
            <div><strong>${escapeHtml(a.title)}</strong> <span class="id">id: ${a.id}</span></div>
            <div>${escapeHtml(a.description)}</div>
            <div class="muted">Due: ${new Date(a.dueDateISO).toLocaleString()}</div>
          </li>
        `).join("") || "<li class='muted'>No assignments.</li>");
      } catch (e) {
        setHTML("stuAssignList", `<li class='muted'>${escapeHtml(e.message)}</li>`);
      }
    });

    // Student: Submit assignment
    document.getElementById("submitBtn").addEventListener("click", async () => {
      const assignmentId = document.getElementById("submitAssignmentId").value.trim();
      const fileInput = document.getElementById("submitFile");
      setText("submitMsg", "");
      if (!assignmentId) { setText("submitMsg", "Enter assignment ID"); return; }
      if (!fileInput.files || fileInput.files.length === 0) { setText("submitMsg", "Choose a file"); return; }
      const fd = new FormData();
      fd.append("assignmentId", assignmentId);
      fd.append("file", fileInput.files[0]);
      try {
        const res = await api("/submissions", { method: "POST", body: fd });
        setText("submitMsg", "Submitted: " + res.id);
        document.getElementById("submitAssignmentId").value = "";
        fileInput.value = "";
      } catch (e) {
        setText("submitMsg", e.message);
      }
    });

    // Student: Send message
    document.getElementById("stuSendMsgBtn").addEventListener("click", async () => {
      const recipientId = document.getElementById("stuMsgRecipient").value.trim();
      const courseId = document.getElementById("stuMsgCourseOpt").value.trim();
      const content = document.getElementById("stuMsgContent").value.trim();
      setText("stuMsgSendStatus", "");
      try {
        await api("/messages", { method: "POST", body: JSON.stringify({ recipientId, content, courseId: courseId || undefined }) });
        setText("stuMsgSendStatus", "Message sent.");
        document.getElementById("stuMsgRecipient").value = "";
        document.getElementById("stuMsgCourseOpt").value = "";
        document.getElementById("stuMsgContent").value = "";
        await loadInboxSent("stuInboxList", "stuSentList");
      } catch (e) {
        setText("stuMsgSendStatus", e.message);
      }
    });

    // Utility
    function escapeHtml(str) {
      if (typeof str !== "string") return str;
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Bootstrap
    (function init() {
      const token = localStorage.getItem("token");
      if (token) {
        setAuth(token);
        // Try fetching inbox to verify token and get minimal user info by requiring a login to set state
        // We don't have a "me" endpoint, so rely on last known user in local storage if you want.
        // For simplicity, ask the user to login after refresh unless token still valid and we cached user.
      }
      // Show auth if we don't know the role
      if (!token) {
        renderAuth();
      } else {
        // We need user object; prompt simple fetch by trying to get courses for both roles
        // Attempt professor first
        api("/courses", { method: "GET" })
          .then(coursesOrErr => {
            // We don't know role yet; find it by trying actions
            // If result is an array, decide role by checking whether we can create assignment/courses.
            // Easiest: ask the user to click one of actions; but we can infer by trying to fetch inbox (works for both).
            // For user display, prompt role selection based on last session; since we don't store role separately, we’ll fallback to asking the server via a tiny trick:
            // We cannot decode JWT without a library; but JWT is standard base64, so let's decode the payload quickly:
            try {
              const payload = JSON.parse(atob(token.split(".")[1]));
              state.user = { id: payload.id, email: "", name: "", role: payload.role };
              state.role = payload.role;
            } catch (e) {}
            if (state.role) renderRole();
            else renderAuth();
          })
          .catch(() => renderAuth());
      }

      // Optional: wire up Enter keys for login/register
      document.getElementById("loginPassword").addEventListener("keydown")
      // File: client/index.html (continued from "keydown")
      document.getElementById("loginPassword").addEventListener("keydown", (e) => {
        if (e.key === "Enter") document.getElementById("loginBtn").click();
      });
      document.getElementById("regPassword").addEventListener("keydown", (e) => {
        if (e.key === "Enter") document.getElementById("registerBtn").click();
      });
    })();
  </script>
</body>
</html>
